<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¬ë¨ë²„ê±° ì…ì  ì í•©ë„ ë¶„ì„ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Kakao Maps SDK -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey7ac6f2a9944d918ae5650b2d2d8935c1&libraries=services"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .swot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }
        .gauge-container {
            position: relative;
            width: 150px;
            height: 75px;
            overflow: hidden;
        }
        .gauge-background {
            position: absolute;
            width: 100%;
            height: 100%;
            background: conic-gradient(from -90deg at 50% 100%, #e0e0e0 0%, #e0e0e0 100%);
            border-radius: 150px 150px 0 0;
        }
        .gauge-fill {
            position: absolute;
            width: 100%;
            height: 100%;
            background: conic-gradient(from -90deg at 50% 100%, #4c51bf 0%, #667eea 100%);
            border-radius: 150px 150px 0 0;
            transform-origin: 50% 100%;
            transition: transform 1.5s ease-out;
        }
        .gauge-cover {
            position: absolute;
            width: 120px;
            height: 60px;
            background: #f7fafc;
            border-radius: 120px 120px 0 0;
            top: 15px;
            left: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .gauge-score {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
        }
        .gauge-label {
            font-size: 0.8rem;
            color: #718096;
            margin-top: -5px;
        }
        #map {
            width: 100%;
            height: 400px;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-700">ğŸ” ìŠ¬ë¨ë²„ê±° ì…ì  ì í•©ë„ ë¶„ì„ê¸°</h1>
            <p class="text-gray-600 mt-2">ìµœì ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ìœ„ì¹˜ë¥¼ ê³¼í•™ì ìœ¼ë¡œ íƒìƒ‰í•˜ê³  ë¶„ì„í•©ë‹ˆë‹¤.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- ì™¼ìª½: ì…ë ¥ ë° ê°€ì¤‘ì¹˜ ì„¤ì • -->
            <section class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">ë¶„ì„ ì •ë³´ ì…ë ¥</h2>
                
                <div class="mb-4">
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-2">ë¶„ì„ ëŒ€ìƒ ì£¼ì†Œ</label>
                    <input type="text" id="address" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123">
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="floor" class="block text-sm font-medium text-gray-700 mb-2">ì¸µ ìˆ˜</label>
                        <input type="number" id="floor" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="ì˜ˆ: 1" value="1">
                    </div>
                    <div>
                        <label for="area" class="block text-sm font-medium text-gray-700 mb-2">í‰ìˆ˜</label>
                        <input type="number" id="area" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="ì˜ˆ: 30" value="30">
                    </div>
                    <div>
                        <label for="deposit" class="block text-sm font-medium text-gray-700 mb-2">ë³´ì¦ê¸ˆ (ë§Œì›)</label>
                        <input type="number" id="deposit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="ì˜ˆ: 15000" value="15000">
                    </div>
                    <div>
                        <label for="rent" class="block text-sm font-medium text-gray-700 mb-2">ì›” ì„ëŒ€ë£Œ (ë§Œì›)</label>
                        <input type="number" id="rent" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="ì˜ˆ: 1000" value="1000">
                    </div>
                </div>

                <div class="mb-6">
                    <label for="salesRatio" class="block text-sm font-medium text-gray-700 mb-2">í™€ / ë°°ë‹¬ ë¹„ì¤‘</label>
                    <input type="range" id="salesRatio" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="0" max="100" value="70">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>ë°°ë‹¬ <span id="deliveryRatio">30</span>%</span>
                        <span>í™€ <span id="dineInRatio">70</span>%</span>
                    </div>
                </div>

                <button id="analyzeBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    ë¶„ì„ ì‹¤í–‰
                </button>

                <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-4">í‰ê°€í•­ëª©ë³„ ê°€ì¤‘ì¹˜ ì„¤ì •</h3>
                    <div id="weights-container" class="space-y-4">
                        <!-- ê°€ì¤‘ì¹˜ ìŠ¬ë¼ì´ë”ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
                    </div>
                    <div class="mt-4 text-right font-bold text-indigo-600">
                        ì´í•©: <span id="total-weight">100</span>%
                    </div>
                </div>
            </section>

            <!-- ì˜¤ë¥¸ìª½: ë¶„ì„ ê²°ê³¼ -->
            <section id="results-section" class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg hidden">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-semibold">ì¢…í•© ë¶„ì„ ê²°ê³¼: <span id="analyzed-address" class="text-indigo-600"></span></h2>
                </div>

                <div class="flex flex-col md:flex-row items-center justify-center gap-8 mb-8">
                     <div class="gauge-container flex-shrink-0">
                        <div class="gauge-background"></div>
                        <div id="gauge-fill" class="gauge-fill" style="transform: rotate(0deg);"></div>
                        <div class="gauge-cover">
                            <div id="total-score" class="gauge-score">0</div>
                            <div class="gauge-label">ì´ ì í•©ë„</div>
                        </div>
                    </div>
                    <div id="map" class="w-full h-64 md:h-auto"></div>
                </div>

                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4">í•­ëª©ë³„ ì í•©ë„ ì ìˆ˜</h3>
                    <div id="scores-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- í•­ëª©ë³„ ì ìˆ˜ ì¹´ë“œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
                    </div>
                </div>
                
                <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-4">SWOT ë¶„ì„</h3>
                    <div id="swot-analysis" class="swot-grid">
                        <!-- SWOT ë¶„ì„ ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
                    </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-4">ìˆ˜ìµì„± ë¶„ì„ (ì›” ë‹¨ìœ„)</h3>
                    <div id="profit-analysis" class="overflow-x-auto">
                        <!-- Profit table will be injected here -->
                    </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-4">ì˜ˆìƒ í•„ìš” ì¸ë ¥ (ì£¼ê°„ ì‹œê°„í‘œ)</h3>
                    <div id="staffing-estimation">
                        <!-- Staffing table will be injected here -->
                    </div>
                </div>
            </section>
             <section id="initial-message" class="lg:col-span-2 flex items-center justify-center bg-white p-6 rounded-2xl shadow-lg">
                <div class="text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-semibold text-gray-900">ë¶„ì„ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.</h3>
                    <p class="mt-1 text-sm text-gray-500">ì£¼ì†Œë¥¼ ì…ë ¥í•˜ê³  'ë¶„ì„ ì‹¤í–‰' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Help Modal -->
    <div id="help-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 transition-opacity duration-300">
        <div class="relative mx-auto p-5 border w-11/12 md:w-96 shadow-lg rounded-2xl bg-white transform transition-all duration-300 scale-95">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100">
                    <svg class="h-6 w-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h3 id="modal-title" class="text-lg leading-6 font-bold text-gray-900 mt-4"></h3>
                <div class="mt-2 px-7 py-3">
                    <p id="modal-content" class="text-sm text-gray-600 text-left"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal-btn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        í™•ì¸
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        window.onload = function() {
            const criteria = {
                'ìƒê¶Œ ì ì¬ë ¥': { weight: 25, description: "í•´ë‹¹ ìƒê¶Œì˜ í•µì‹¬ íƒ€ê²Ÿ ê³ ê°ì¸µ(20-30ëŒ€)ì˜ ì†Œë¹„ë ¥ê³¼ íŒ¨ìŠ¤íŠ¸í‘¸ë“œ ì—…ì¢…ì˜ ì „ë°˜ì ì¸ ì„±ì¥ ê°€ëŠ¥ì„±ì„ í‰ê°€í•©ë‹ˆë‹¤. ì„œìš¸ì‹œ ìƒê¶Œë¶„ì„ ë°ì´í„°ì˜ ì—…ì¢…ë³„ ì¶”ì • ë§¤ì¶œ, ì—°ë ¹ëŒ€ë³„ ì†Œë¹„ íŒ¨í„´ ë“±ì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤." },
                'ìœ ë™ì¸êµ¬': { weight: 20, description: "ë§¤ì¥ ì•ì„ ì§€ë‚˜ê°€ëŠ” ì ì¬ ê³ ê°ì˜ ìˆ˜ë¥¼ í‰ê°€í•©ë‹ˆë‹¤. ì£¼ì¤‘/ì£¼ë§ ë° ì ì‹¬/ì €ë… í”¼í¬íƒ€ì„ì˜ ìœ ë™ì¸êµ¬ë¥¼ ë¶„ì„í•˜ì—¬ ì‹¤ì œ ë°©ë¬¸ìœ¼ë¡œ ì´ì–´ì§ˆ ê°€ëŠ¥ì„±ì„ ì˜ˆì¸¡í•©ë‹ˆë‹¤." },
                'ê²½ìŸ í™˜ê²½': { weight: 15, description: "ë°˜ê²½ 300m ë‚´ ì£¼ìš” ê²½ìŸì‚¬(ë§¥ë„ë‚ ë“œ, ë²„ê±°í‚¹ ë“±)ì˜ ìˆ˜ì™€ ë¶„í¬ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤. ê²½ìŸì´ ê³¼ë„í•˜ì§€ ì•Šìœ¼ë©´ì„œë„, í–„ë²„ê±°ì— ëŒ€í•œ ìˆ˜ìš”ê°€ ê²€ì¦ëœ ìƒê¶Œì¸ì§€ í‰ê°€í•©ë‹ˆë‹¤." },
                'ì ‘ê·¼ì„± ë° ê°€ì‹œì„±': { weight: 15, description: "ê³ ê°ì´ ë§¤ì¥ì„ ì–¼ë§ˆë‚˜ ì‰½ê²Œ ì°¾ê³  ë°©ë¬¸í•  ìˆ˜ ìˆëŠ”ì§€ë¥¼ í‰ê°€í•©ë‹ˆë‹¤. ì§€í•˜ì² ì—­, ë²„ìŠ¤ì •ë¥˜ì¥ê³¼ì˜ ê±°ë¦¬, ëŒ€ë¡œë³€ ì½”ë„ˆ ìœ„ì¹˜ ì—¬ë¶€, ë§¤ì¥ ì „ë©´ì˜ ê°œë°©ê° ë“±ì„ ì¢…í•©ì ìœ¼ë¡œ íŒë‹¨í•©ë‹ˆë‹¤." },
                'ë¹„ìš© íš¨ìœ¨ì„±': { weight: 15, description: "ì´ˆê¸° íˆ¬ìë¹„ì™€ ê³ ì •ë¹„ ë¶€ë‹´ì„ í‰ê°€í•©ë‹ˆë‹¤. ë³´ì¦ê¸ˆ, ì›” ì„ëŒ€ë£Œ, ê¶Œë¦¬ê¸ˆ ë“±ì„ ì£¼ë³€ ì‹œì„¸ì™€ ë¹„êµí•˜ì—¬ ìˆ˜ìµì„± ëŒ€ë¹„ ë¹„ìš© êµ¬ì¡°ê°€ í•©ë¦¬ì ì¸ì§€ ë¶„ì„í•©ë‹ˆë‹¤." },
                'ë¬¼ë¦¬ì  ì¡°ê±´': { weight: 10, description: "ë§¤ì¥ ìš´ì˜ì— í•„ìš”í•œ ë¬¼ë¦¬ì  ìš”ê±´ì„ í‰ê°€í•©ë‹ˆë‹¤. ì „ìš© ë©´ì , ì¸µìˆ˜(1ì¸µ ì„ í˜¸), ì£¼ë°© ë° í™€ ê³µê°„ í™•ë³´ ê°€ëŠ¥ì„±, ì£¼ì°¨ ê°€ëŠ¥ ì—¬ë¶€ ë“±ì„ ê²€í† í•©ë‹ˆë‹¤." },
            };

            const weightsContainer = document.getElementById('weights-container');
            const totalWeightEl = document.getElementById('total-weight');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const addressInput = document.getElementById('address');
            const resultsSection = document.getElementById('results-section');
            const initialMessage = document.getElementById('initial-message');
            const salesRatioSlider = document.getElementById('salesRatio');
            const deliveryRatioEl = document.getElementById('deliveryRatio');
            const dineInRatioEl = document.getElementById('dineInRatio');
            const mapContainer = document.getElementById('map');
            
            // Modal elements
            const helpModal = document.getElementById('help-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const closeModalBtn = document.getElementById('close-modal-btn');

            let map = null;
            let markers = [];
            let currentWeights = {};
            
            salesRatioSlider.addEventListener('input', (e) => {
                const dineInRatio = e.target.value;
                dineInRatioEl.textContent = dineInRatio;
                deliveryRatioEl.textContent = 100 - dineInRatio;
            });

            function initializeWeights() {
                weightsContainer.innerHTML = '';
                for (const key in criteria) {
                    currentWeights[key] = criteria[key].weight;
                    const weightItem = document.createElement('div');
                    weightItem.innerHTML = `
                        <div class="flex items-center justify-between mb-1">
                             <label for="${key}-weight" class="block text-sm font-medium text-gray-700">${key}</label>
                             <svg data-key="${key}" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 hover:text-indigo-600 cursor-pointer help-icon" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="flex items-center space-x-3">
                            <input type="range" id="${key}-weight" name="${key}-weight" min="0" max="50" value="${currentWeights[key]}" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                            <span class="font-semibold text-indigo-600 w-12 text-right">${currentWeights[key]}%</span>
                        </div>
                    `;
                    weightsContainer.appendChild(weightItem);
                }
                updateTotalWeight();
            }

            function updateTotalWeight() {
                const total = Object.values(currentWeights).reduce((sum, val) => sum + val, 0);
                totalWeightEl.textContent = total;
                totalWeightEl.parentElement.classList.toggle('text-red-600', total !== 100);
                totalWeightEl.parentElement.classList.toggle('text-indigo-600', total === 100);
            }
            
            weightsContainer.addEventListener('input', (e) => {
                if (e.target.type === 'range') {
                    const key = e.target.name.replace('-weight', '');
                    currentWeights[key] = parseInt(e.target.value);
                    e.target.nextElementSibling.textContent = `${currentWeights[key]}%`;
                    updateTotalWeight();
                }
            });

            weightsContainer.addEventListener('click', (e) => {
                const icon = e.target.closest('.help-icon');
                if (icon) {
                    const key = icon.dataset.key;
                    showHelpPopup(key);
                }
            });

            function showHelpPopup(key) {
                const criterion = criteria[key];
                if (criterion) {
                    modalTitle.textContent = key;
                    modalContent.textContent = criterion.description;
                    helpModal.classList.remove('hidden');
                    setTimeout(() => {
                         helpModal.querySelector('div').classList.remove('scale-95');
                    }, 10);
                }
            }

            function hideHelpPopup() {
                helpModal.querySelector('div').classList.add('scale-95');
                setTimeout(() => {
                    helpModal.classList.add('hidden');
                }, 300);
            }
            
            closeModalBtn.addEventListener('click', hideHelpPopup);
            helpModal.addEventListener('click', (e) => {
                if (e.target === helpModal) {
                    hideHelpPopup();
                }
            });

            analyzeBtn.addEventListener('click', async () => {
                const address = addressInput.value.trim();
                const userInput = {
                    floor: parseInt(document.getElementById('floor').value), area: parseInt(document.getElementById('area').value),
                    deposit: parseInt(document.getElementById('deposit').value), rent: parseInt(document.getElementById('rent').value),
                    salesRatio: parseInt(salesRatioSlider.value),
                };

                if (address === '' || Object.values(userInput).some(isNaN)) {
                    alert('ëª¨ë“  ë¶„ì„ ì •ë³´ë¥¼ ë¹ ì§ì—†ì´ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return;
                }
                if (Object.values(currentWeights).reduce((s, v) => s + v, 0) !== 100) {
                    alert('ê°€ì¤‘ì¹˜ì˜ ì´í•©ì€ 100%ê°€ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.'); return;
                }
                
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = 'ë¶„ì„ ì¤‘...';

                try {
                    const apiData = await analyzeWithKakaoAPI(address);
                    const analysisData = generateAnalysisData(userInput, apiData, address);
                    
                    resultsSection.classList.remove('hidden');
                    initialMessage.classList.add('hidden');
                    document.getElementById('analyzed-address').textContent = address;
                    
                    displayMap(apiData.mainCoords, apiData.competitorPlaces);
                    displayResults(analysisData);
                    calculateAndDisplayProfitability(userInput);
                    calculateAndDisplayStaffing(analysisData);
                } catch (error) {
                    console.error("Analysis failed:", error);
                    alert(error.message || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                } finally {
                    analyzeBtn.disabled = false;
                    analyzeBtn.textContent = 'ë¶„ì„ ì‹¤í–‰';
                }
            });
            
            async function analyzeWithKakaoAPI(address) {
                const geocoder = new kakao.maps.services.Geocoder();
                const places = new kakao.maps.services.Places();

                const getCoords = () => new Promise((resolve, reject) => {
                    geocoder.addressSearch(address, (result, status) => {
                        if (status === kakao.maps.services.Status.OK) {
                            resolve({ lat: result[0].y, lng: result[0].x });
                        } else { reject(new Error('ìœ íš¨í•œ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')); }
                    });
                });

                const searchNearby = (coords, keyword, radius) => new Promise((resolve) => {
                    places.keywordSearch(keyword, (result, status, pagination) => {
                        if (status === kakao.maps.services.Status.OK) {
                            resolve({ count: pagination.totalCount, places: result });
                        } else { resolve({ count: 0, places: [] }); }
                    }, { location: new kakao.maps.LatLng(coords.lat, coords.lng), radius: radius });
                });

                const coords = await getCoords();
                // Specific list of burger and sandwich competitors
                const competitors = [
                    'ë§¥ë„ë‚ ë“œ', 'ë²„ê±°í‚¹', 'ë¡¯ë°ë¦¬ì•„', 'ë§˜ìŠ¤í„°ì¹˜', 'ë²„ê±°ë¦¬', 
                    'í”„ë­í¬ë²„ê±°', 'KFC', 'íŒŒíŒŒì´ìŠ¤', 'ì‰ì´í¬ì‰‘', 'íŒŒì´ë¸Œê°€ì´ì¦ˆ', 
                    'í¬ë¼ì´ì¹˜ì¦ˆë²„ê±°', 'ë°”ìŠ¤ë²„ê±°', 'ì¨ë¸Œì›¨ì´', 'í€´ì¦ˆë…¸ìŠ¤', 'ë²„ê±°'
                ];
                const competitorPromises = competitors.map(c => searchNearby(coords, c, 300));
                const competitorResults = await Promise.all(competitorPromises);
                
                // Flatten the array of places from all search results
                const allPlaces = competitorResults.flatMap(r => r.places);

                // Remove duplicates using a Map, keyed by the place ID
                const uniquePlaces = Array.from(new Map(allPlaces.map(place => [place.id, place])).values());
                
                const totalCompetitors = uniquePlaces.length;
                const competitorPlaces = uniquePlaces;

                const subwayResult = await searchNearby(coords, 'ì§€í•˜ì² ì—­', 500);
                const nearestSubwayDist = subwayResult.places.length > 0 ? parseInt(subwayResult.places[0].distance) : 9999;
                const busStopResult = await searchNearby(coords, 'ë²„ìŠ¤ì •ë¥˜ì¥', 100);

                return {
                    mainCoords: coords,
                    totalCompetitors,
                    competitorPlaces,
                    nearestSubwayDist,
                    busStopCount: busStopResult.count,
                };
            }
            
            function displayMap(mainCoords, competitorPlaces) {
                const mapOption = { 
                    center: new kakao.maps.LatLng(mainCoords.lat, mainCoords.lng), 
                    level: 4 
                };
                if (!map) {
                    map = new kakao.maps.Map(mapContainer, mapOption);
                } else {
                    map.setCenter(new kakao.maps.LatLng(mainCoords.lat, mainCoords.lng));
                }

                markers.forEach(marker => marker.setMap(null));
                markers = [];

                const mainMarkerImage = new kakao.maps.MarkerImage(
                    'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png',
                    new kakao.maps.Size(64, 69), 
                    {offset: new kakao.maps.Point(27, 69)}
                );
                const mainMarker = new kakao.maps.Marker({
                    position: map.getCenter(),
                    image: mainMarkerImage
                });
                mainMarker.setMap(map);
                markers.push(mainMarker);

                competitorPlaces.forEach(place => {
                    const marker = new kakao.maps.Marker({
                        map: map,
                        position: new kakao.maps.LatLng(place.y, place.x)
                    });
                    const infowindow = new kakao.maps.InfoWindow({
                        content: `<div style="padding:5px;font-size:12px;">${place.place_name}</div>`
                    });
                    kakao.maps.event.addListener(marker, 'mouseover', () => infowindow.open(map, marker));
                    kakao.maps.event.addListener(marker, 'mouseout', () => infowindow.close());
                    markers.push(marker);
                });
            }
            
            // Function to create a consistent hash from a string
            function simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash |= 0; // Convert to 32bit integer
                }
                return Math.abs(hash);
            }

            function generateAnalysisData(userInput, apiData, address) {
                const data = {};
                const addressHash = simpleHash(address);

                let competitionScore = 100 - (apiData.totalCompetitors * 15);
                competitionScore = Math.max(10, competitionScore);
                let accessibilityScore = 0;
                accessibilityScore += Math.max(0, 100 - (apiData.nearestSubwayDist / 5));
                accessibilityScore += Math.min(100, apiData.busStopCount * 25);
                accessibilityScore = Math.round(accessibilityScore / 2);
                let physicalScore = 0;
                if (userInput.floor === 1) physicalScore += 100; else if (userInput.floor === 2) physicalScore += 70; else physicalScore += 20;
                if (userInput.area < 25) physicalScore += 20; else if (userInput.area <= 35) physicalScore += 85; else if (userInput.area <= 50) physicalScore += 100; else physicalScore += 90;
                physicalScore = Math.round(physicalScore / 2);
                const costMetric = (userInput.deposit / 10) + userInput.rent;
                let costScore = 100 - ((costMetric - 1500) / 4500) * 100;
                costScore = Math.round(Math.max(10, Math.min(100, costScore)));
                
                // Use the hash to generate consistent scores for simulated data
                const potentialScore = 40 + (addressHash % 61); // Consistent score between 40-100
                const trafficScore = 40 + Math.floor(addressHash / 10000) % 61; // Consistent score between 40-100

                data['ìƒê¶Œ ì ì¬ë ¥'] = { score: potentialScore, details: {'2030 ë§¤ì¶œ ë¹„ì¤‘': `${(40 + (addressHash % 35)).toFixed(1)}%`} };
                data['ìœ ë™ì¸êµ¬'] = { score: trafficScore, details: {'ì£¼ì¤‘ ì ì‹¬ (12-13ì‹œ)': `${600 + (addressHash % 400)}ëª…`} };
                data['ê²½ìŸ í™˜ê²½'] = { score: competitionScore, details: { 'ì£¼ìš” ê²½ìŸì‚¬ ìˆ˜ (ë°˜ê²½ 300m)': `${apiData.totalCompetitors}ê°œ` } };
                data['ì ‘ê·¼ì„± ë° ê°€ì‹œì„±'] = { score: accessibilityScore, details: { 'ê°€ì¥ ê°€ê¹Œìš´ ì§€í•˜ì² ì—­': `${apiData.nearestSubwayDist}m`, 'ë²„ìŠ¤ì •ë¥˜ì¥ ìˆ˜ (ë°˜ê²½ 100m)': `${apiData.busStopCount}ê°œ` } };
                data['ë¹„ìš© íš¨ìœ¨ì„±'] = { score: costScore, details: { 'ë³´ì¦ê¸ˆ': `${userInput.deposit.toLocaleString()} ë§Œì›`, 'ì›” ì„ëŒ€ë£Œ': `${userInput.rent.toLocaleString()} ë§Œì›` } };
                data['ë¬¼ë¦¬ì  ì¡°ê±´'] = { score: physicalScore, details: { 'ì „ìš© ë©´ì  (í‰)': `${userInput.area} í‰`, 'ì¸µ ìˆ˜': `${userInput.floor} ì¸µ` } };
                
                return data;
            }

            function displayResults(data) {
                let totalScore = 0;
                const scoresContainer = document.getElementById('scores-container');
                scoresContainer.innerHTML = '';
                const totalWeight = Object.values(currentWeights).reduce((sum, val) => sum + val, 0);
                for (const key in data) {
                    const weight = currentWeights[key];
                    const score = data[key].score;
                    totalScore += (score * weight / totalWeight);
                    const scoreColor = score >= 80 ? 'bg-blue-500' : score >= 60 ? 'bg-green-500' : score >= 40 ? 'bg-yellow-500' : 'bg-red-500';
                    let detailsHtml = '<ul class="text-xs text-gray-500 mt-2 pl-4 list-disc space-y-1">';
                    for(const detailKey in data[key].details) {
                        detailsHtml += `<li>${detailKey}: <span class="font-medium text-gray-700">${data[key].details[detailKey]}</span></li>`;
                    }
                    detailsHtml += '</ul>';
                    const scoreItem = document.createElement('div');
                    scoreItem.className = 'bg-gray-50 p-4 rounded-lg border';
                    scoreItem.innerHTML = `<div class="flex justify-between items-center"><span class="font-semibold text-sm">${key}</span><span class="font-bold text-lg text-indigo-700">${score}ì </span></div><div class="w-full bg-gray-200 rounded-full h-2 mt-2"><div class="${scoreColor} h-2 rounded-full" style="width: ${score}%"></div></div>${detailsHtml}`;
                    scoresContainer.appendChild(scoreItem);
                }
                totalScore = Math.round(totalScore);
                const totalScoreEl = document.getElementById('total-score');
                const gaugeFillEl = document.getElementById('gauge-fill');
                let currentAnimatedScore = 0;
                const interval = setInterval(() => {
                    currentAnimatedScore++;
                    if (currentAnimatedScore >= totalScore) clearInterval(interval);
                    totalScoreEl.textContent = Math.min(totalScore, currentAnimatedScore);
                }, 20);
                gaugeFillEl.style.transform = `rotate(${(totalScore / 100) * 180}deg)`;
                displaySwot(data);
            }
            
            function formatCurrency(num) {
                return `${(num / 10000).toLocaleString('ko-KR')} ë§Œì›`;
            }

            function calculateAndDisplayProfitability(userInput) {
                const profitContainer = document.getElementById('profit-analysis');
                const salesLevels = [6000, 8000, 10000, 12000, 15000]; // ë§Œì› ë‹¨ìœ„
                const dineInRatio = userInput.salesRatio / 100;
                const deliveryRatio = 1 - dineInRatio;

                const constants = { cogsRate: 0.38, deliveryFeeRate: 0.45, laborRate: 0.16, utilities: 180, otherCosts: 100, cardFeeRate: 0.015 };
                
                let tableHtml = `<table class="w-full text-sm text-center text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th scope="col" class="px-4 py-3 text-left">í•­ëª©</th>`;
                salesLevels.forEach(s => tableHtml += `<th scope="col" class="px-4 py-3">${s.toLocaleString()}ë§Œ</th>`);
                tableHtml += `</tr></thead><tbody>`;

                const rowsInOrder = [
                    { key: "ë§¤ì¶œì•¡", calc: (s, res) => s * 10000 },
                    { key: "(-) ì›ì¬ë£Œë¹„", calc: (s, res) => s * 10000 * constants.cogsRate },
                    { key: "(-) ë°°ë‹¬ìˆ˜ìˆ˜ë£Œ", calc: (s, res) => s * 10000 * deliveryRatio * constants.deliveryFeeRate },
                    { key: "ë§¤ì¶œì´ì´ìµ", calc: (s, res) => res["ë§¤ì¶œì•¡"] - res["(-) ì›ì¬ë£Œë¹„"] - res["(-) ë°°ë‹¬ìˆ˜ìˆ˜ë£Œ"] },
                    { key: "(-) ì„ëŒ€ë£Œ", calc: (s, res) => userInput.rent * 10000 },
                    { key: "(-) ì¸ê±´ë¹„", calc: (s, res) => s * 10000 * constants.laborRate },
                    { key: "(-) ê³µê³¼ì¡ë¹„", calc: (s, res) => constants.utilities * 10000 },
                    { key: "(-) ê¸°íƒ€ë¹„ìš©", calc: (s, res) => constants.otherCosts * 10000 },
                    { key: "(-) ì¹´ë“œìˆ˜ìˆ˜ë£Œ", calc: (s, res) => s * 10000 * constants.cardFeeRate },
                    { key: "ì„¸ì „ì´ìµ", calc: (s, res) => res["ë§¤ì¶œì´ì´ìµ"] - res["(-) ì„ëŒ€ë£Œ"] - res["(-) ì¸ê±´ë¹„"] - res["(-) ê³µê³¼ì¡ë¹„"] - res["(-) ê¸°íƒ€ë¹„ìš©"] - res["(-) ì¹´ë“œìˆ˜ìˆ˜ë£Œ"] },
                    { key: "ë§ˆì§„ìœ¨", calc: (s, res) => (res["ì„¸ì „ì´ìµ"] / res["ë§¤ì¶œì•¡"]) * 100 }
                ];
                
                // Pre-calculate all data, column by column
                const tableData = salesLevels.map(s => {
                    const columnResults = {};
                    rowsInOrder.forEach(row => {
                        columnResults[row.key] = row.calc(s, columnResults);
                    });
                    return columnResults;
                });

                // Build the HTML table from the pre-calculated data
                rowsInOrder.forEach(row => {
                    const title = row.key;
                    const isProfitRow = title === 'ì„¸ì „ì´ìµ';
                    const isMarginRow = title === 'ë§ˆì§„ìœ¨';
                    const isHeaderRow = title === 'ë§¤ì¶œì´ì´ìµ';

                    tableHtml += `<tr class="border-b ${isHeaderRow ? 'bg-gray-50' : 'bg-white'}"><td class="px-4 py-2 font-medium text-gray-900 text-left ${isProfitRow ? 'font-bold' : ''}">${title}</td>`;
                    
                    tableData.forEach(column => {
                        const value = column[title];
                        if (isNaN(value)) {
                            tableHtml += `<td class="px-4 py-2">N/A</td>`;
                            return;
                        }
                        const profitColor = value > 0 ? 'text-green-600' : 'text-red-600';

                        tableHtml += `<td class="px-4 py-2 ${isProfitRow || isMarginRow ? `font-bold ${profitColor}` : ''}">${isMarginRow ? `${value.toFixed(1)}%` : formatCurrency(value)}</td>`;
                    });
                    tableHtml += `</tr>`;
                });

                tableHtml += `</tbody></table>`;
                profitContainer.innerHTML = tableHtml;
            }

            function calculateAndDisplayStaffing(data) {
                const staffingContainer = document.getElementById('staffing-estimation');
                const salesProxy = data['ìœ ë™ì¸êµ¬'].score;
                const salesFactor = Math.round((salesProxy - 60) / 20); // 60ì  ê¸°ì¤€, 20ì ë§ˆë‹¤ 1ëª… ì¦ê°
                
                const staff = {
                    weekday: { open: 2, middle: 3, close: 2 },
                    weekend: { open: 2, middle: 4, close: 3 }
                };

                const finalStaff = {
                    weekday: {
                        open: Math.max(1, staff.weekday.open + salesFactor),
                        middle: Math.max(2, staff.weekday.middle + salesFactor),
                        close: Math.max(1, staff.weekday.close + salesFactor)
                    },
                    weekend: {
                        open: Math.max(1, staff.weekend.open + salesFactor),
                        middle: Math.max(2, staff.weekend.middle + salesFactor + 1), // ì£¼ë§ ë¯¸ë“¤ 1ëª… ì¶”ê°€
                        close: Math.max(2, staff.weekend.close + salesFactor)
                    }
                };
                
                staffingContainer.innerHTML = `
                    <table class="w-full text-sm text-center text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th scope="col" class="px-6 py-3">êµ¬ë¶„</th>
                                <th scope="col" class="px-6 py-3">ì˜¤í”ˆ (10~17ì‹œ)</th>
                                <th scope="col" class="px-6 py-3">ë¯¸ë“¤ (12~21ì‹œ)</th>
                                <th scope="col" class="px-6 py-3">ë§ˆê° (16~23ì‹œ)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-white border-b">
                                <th scope="row" class="px-6 py-4 font-medium text-gray-900">í‰ì¼</th>
                                <td class="px-6 py-4">${finalStaff.weekday.open} ëª…</td>
                                <td class="px-6 py-4">${finalStaff.weekday.middle} ëª…</td>
                                <td class="px-6 py-4">${finalStaff.weekday.close} ëª…</td>
                            </tr>
                            <tr class="bg-white">
                                <th scope="row" class="px-6 py-4 font-medium text-gray-900">ì£¼ë§/ê³µíœ´ì¼</th>
                                <td class="px-6 py-4">${finalStaff.weekend.open} ëª…</td>
                                <td class="px-6 py-4">${finalStaff.weekend.middle} ëª…</td>
                                <td class="px-6 py-4">${finalStaff.weekend.close} ëª…</td>
                            </tr>
                        </tbody>
                    </table>`;
            }
            
            function displaySwot(data) {
                const swotContainer = document.getElementById('swot-analysis');
                swotContainer.innerHTML = '';
                const strengths = Object.entries(data).filter(([k, v]) => v.score >= 80);
                const weaknesses = Object.entries(data).filter(([k, v]) => v.score <= 50);
                let swot = { S: [], W: [], O: [], T: [] };

                if(strengths.length > 0) { strengths.forEach(item => swot.S.push(`${item[0]} í•­ëª©ì˜ ë†’ì€ ì ìˆ˜`)); }
                else { swot.S.push(`ìƒëŒ€ì ìœ¼ë¡œ ìš°ìˆ˜í•œ ${Object.entries(data).sort((a, b) => b[1].score - a[1].score)[0][0]}`); }
                if (data['ì ‘ê·¼ì„± ë° ê°€ì‹œì„±'].score > 80) swot.S.push('ì—­ì„¸ê¶Œì— ìœ„ì¹˜í•˜ì—¬ ì ‘ê·¼ì„± ìš°ìˆ˜');
                if (data['ë¬¼ë¦¬ì  ì¡°ê±´'].details['ì¸µ ìˆ˜'] === '1 ì¸µ') swot.S.push('1ì¸µì— ìœ„ì¹˜í•˜ì—¬ ê°€ì‹œì„± í™•ë³´');

                if(weaknesses.length > 0) { weaknesses.forEach(item => swot.W.push(`${item[0]} í•­ëª©ì˜ ë‚®ì€ ê²½ìŸë ¥`)); }
                else { swot.W.push(`ê°œì„ ì´ í•„ìš”í•œ ${Object.entries(data).sort((a, b) => a[1].score - b[1].score)[0][0]} ìš”ì†Œ`); }
                if (data['ë¹„ìš© íš¨ìœ¨ì„±'].score < 50) swot.W.push(`ë†’ì€ ì„ëŒ€ë£Œë¡œ ì¸í•œ ì´ˆê¸° íˆ¬ì ë¶€ë‹´ ë° ìˆ˜ìµì„± ì•…í™” ìš°ë ¤`);

                swot.O.push(`ì£¼ë³€ ì˜¤í”¼ìŠ¤/ëŒ€í•™ê°€ ì—°ê³„ í”„ë¡œëª¨ì…˜ í†µí•œ ë‹¨ê³¨ ê³ ê° í™•ë³´ ê°€ëŠ¥ì„±`);
                if(data['ë¬¼ë¦¬ì  ì¡°ê±´'].score > 70) swot.O.push(`ë„“ê³  ì¾Œì í•œ ë§¤ì¥ í™˜ê²½ì„ í™œìš©í•œ ë¸Œëœë“œ ì´ë¯¸ì§€ ì œê³ `);
                swot.O.push(`ë°°ë‹¬ ìˆ˜ìš”ê°€ ë§ì€ ì§€ì—­ì¼ ê²½ìš°, í™€ ë§¤ì¶œ ì™¸ ì¶”ê°€ ìˆ˜ìµ ì°½ì¶œ ìš©ì´`);

                swot.T.push(`ê²½ê¸° ì¹¨ì²´ë¡œ ì¸í•œ ì™¸ì‹ ì†Œë¹„ ì‹¬ë¦¬ ìœ„ì¶• ê°€ëŠ¥ì„±`);
                if(data['ê²½ìŸ í™˜ê²½'].score < 50) swot.T.push(`ê²½ìŸì‚¬ì˜ ê³µê²©ì ì¸ ë§ˆì¼€íŒ… ë° ì‹ ë©”ë‰´ ì¶œì‹œì— ë”°ë¥¸ ê³ ê° ì´íƒˆ ìœ„í—˜`);
                
                const swotMapping = { S: { title: 'ê°•ì  (Strength)', color: 'blue' }, W: { title: 'ì•½ì  (Weakness)', color: 'red' }, O: { title: 'ê¸°íšŒ (Opportunity)', color: 'green' }, T: { title: 'ìœ„í˜‘ (Threat)', color: 'yellow' } };
                for (const key in swotMapping) {
                    const { title, color } = swotMapping[key];
                    let itemsHtml = swot[key].map(item => `<li class="flex items-start"><span class="text-${color}-500 mr-2">âœ“</span>${item}</li>`).join('');
                    swotContainer.innerHTML += `<div class="bg-gray-50 p-4 rounded-lg border border-${color}-200"><h4 class="font-bold text-lg text-${color}-700 mb-2">${title}</h4><ul class="space-y-1 text-sm text-gray-700">${itemsHtml}</ul></div>`;
                }
            }
            
            initializeWeights();
        };
    </script>
</body>
</html>

